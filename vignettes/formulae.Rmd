---
title: "Formulae"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Formulae}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(jumps)
```

# Introduction

We report all the formulae used in the main computations that take place in the package as a reference for the users and developers.

# Basic model for the HP filter with jumps

The basic model is based on the state-space representation
$$
\begin{aligned}
  y_t &= \alpha^{(1)}_t + \varepsilon_t, \qquad &\varepsilon_t \sim NID(0, \sigma^2_{\varepsilon}) \\
  \alpha^{(1)}_{t+1} &= \alpha^{(1)}_{t} + \alpha^{(2)}_{t} + \eta_{t}, \qquad &\eta_t \sim NID(0, \sigma^2_{\eta, t}) \\
  \alpha^{(2)}_{t+1} &= \alpha^{(2)}_{t} + \zeta_{t}, \qquad &\zeta_t \sim NID(0, \sigma^2_{\zeta,t})
\end{aligned}
$$
with initial conditions
$$
  \begin{bmatrix}
    \alpha^{(1)}_1 \\
    \alpha^{(2)}_1
  \end{bmatrix}
  \sim N\left(
    \begin{bmatrix}
      a^{(1)}_1 \\
      a^{(2)}_1
    \end{bmatrix},
    \begin{bmatrix}
      p^{(11)}_1 & p^{(12)}_1\\
      p^{(12)}_1 & p^{(22)}_1
    \end{bmatrix}      
  \right).
$$

## Scalar Kalman filtering recursions

The Kalman filtering recursions, written in scalar form (to gain computational speed and insights) are the following.

The initial innovation, its variance and the Kalman gains are.
$$
\begin{aligned}
i_1 &= y_1 - a^{(1)}_1 \\
f_1 &= p^{(11)}_1 + \sigma^2_{\varepsilon} \\
k^{(1)}_1 &= \left(p^{(11)}_1 + p^{(12)}_1\right) / f_1 \\
k^{(2)}_1 &= p^{(12)}_1 / f_1
\end{aligned}
$$
For $t=1, 2, \ldots, n-1$ the recursions are
$$
\begin{aligned}
a^{(1)}_{t+1} &= a^{(1)}_{t} + a^{(2)}_{t} + k^{(1)}_t i_t \\
a^{(2)}_{t+1} &= a^{(2)}_{t} + k^{(2)}_t i_t \\
\\
p^{(11)}_{t+1} &= p^{(11)}_t + 2 p^{(12)}_t + p^{(22)}_t + \sigma^2_{\eta,t} - k^{(1)}_t k^{(1)}_t f_t \\
p^{(12)}_{t+1} &= p^{(12)}_t + p^{(22)}_t - k^{(1)}_t k^{(2)}_t f_t\\
p^{(22)}_{t+1} &= p^{(22)}_t + \sigma^2_{\zeta,t} - k^{(2)}_t k^{(2)}_t f_t\\
\\
i_{t+1} &= y_{t+1} - a^{(1)}_{t+1} \\
f_{t+1} &= p^{11}_{t+1} + \sigma^2_{\varepsilon} \\
k^{(1)}_{t+1} &= \left(p^{(11)}_{t+1} + p^{(12)}_{t+1}\right) / f_{t+1} \\
k^{(2)}_{t+1} &= p^{(12)}_{t+1} / f_{t+1}
\end{aligned}
$$

## Modifications when missing observations are present

When one ore more values of $y_t$ are missing, then the only modifications to the above recursions are the following.
$$
\begin{aligned}
i_{t+1} &= 0 \\
f_{t+1} &= \infty \\
k^{(1)}_{t+1} &= 0 \\
k^{(1)}_{t+1} &= 0
\end{aligned}.
$$

## Diffuse initial conditions

Since the two state variables are nonstationary, their initialization should be diffuse:
$$
  \begin{bmatrix}
    \alpha^{(1)}_1 \\
    \alpha^{(2)}_1
  \end{bmatrix}
  \sim N\left(
    \begin{bmatrix}
      0 \\
      0
    \end{bmatrix},
    \begin{bmatrix}
      v & 0\\
      0 & v
    \end{bmatrix}      
  \right),
$$
with $v \rightarrow\infty$.

Let us carry out the computations for $t=1, 2, 3$ and then take the limit for $v \rightarrow\infty$.

### $t=1$
$$
\begin{aligned}
a_1^{(1)}  &= 0 \\
a_1^{(2)}  &= 0 \\
p_1^{(11)} &= v \\
p_1^{(12)} &= 0 \\
p_1^{(22)} &= v \\
i_1        &= y_1 \\
f_1        &= v + \sigma^2_{\varepsilon} \\
k_1^{(1)}  &= v/(v + \sigma^2_{\varepsilon}) \\
k_1^{(2)}  &= 0
\end{aligned}
$$

### $t=2$
$$
\begin{aligned}
a_2^{(1)}  &= y_1 \\
a_2^{(2)}  &= 0 \\
p_2^{(11)} &= 2v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon} \\
p_2^{(12)} &= v \\
p_2^{(22)} &= v + \sigma^2_{\zeta,1} \\
i_2        &= y_2 - \frac{v}{v + \sigma^2_\varepsilon}y_1 \rightarrow y_2 - y_1 \\
f_2        &= 2v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon} + \sigma^2_\varepsilon \\
k_2^{(1)}  &= \frac{3v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon}}{2v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon} + \sigma^2_\varepsilon} \rightarrow 2 \\
k_2^{(2)}  &= \frac{v}{2v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon} + \sigma^2_\varepsilon} \rightarrow 1
\end{aligned}
$$

### $t=3$
$$
\begin{aligned}
a_3^{(1)}  &= \frac{v^2}{v + \sigma^2_\varepsilon}y_1 +
  \frac{3v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon}}{2v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon} + \sigma^2_\varepsilon}\left(y_2 - \frac{v^2}{v + \sigma^2_\varepsilon}y_1\right)
  \rightarrow 2y_2 - y_1\\
a_3^{(2)}  &= \frac{3v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon}}{2v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon} + \sigma^2_\varepsilon}\left(y_2 - \frac{v^2}{v + \sigma^2_\varepsilon}y_1\right)
  \rightarrow y_2 - y_1 \\
p_3^{(11)} &= 5v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon} + \sigma^2_{\zeta,1} + \sigma^2_{\eta,2}
  - \frac{\left(3v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon}\right)^2}{2v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon} + \sigma^2_\varepsilon}
\rightarrow \sigma^2_{\eta,1} + \sigma^2_{\eta,2} + \sigma^2_{\zeta,1} \\
p_3^{(12)} &= 2v + \sigma^2_{\zeta,1} - \frac{v\left(3v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon}\right)}{2v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon} + \sigma^2_\varepsilon} \rightarrow \sigma^2_{\zeta,1}\\
p_3^{(22)} &= v + \sigma^2_{\zeta,1} + \sigma^2_{\zeta,2} - \frac{v^2}{2v + \sigma^2_{\eta,1} - \frac{v^2}{v + \sigma^2_\varepsilon} + \sigma^2_\varepsilon} \rightarrow \sigma^2_{\zeta,1} + \sigma^2_{\zeta,2}\\
i_3        &\rightarrow y_3 - 2y_2 + y_1 \\
f_3        &\rightarrow \sigma^2_{\eta,1} + \sigma^2_{\eta,2} + \sigma^2_{\zeta,1} + \sigma^2_\varepsilon \\
k_3^{(1)}  &\rightarrow  \frac{\sigma^2_{\eta,1} + \sigma^2_{\eta,2} + 2\sigma^2_{\zeta,1}}{\sigma^2_{\eta,1} + \sigma^2_{\eta,2} + \sigma^2_{\zeta,1} + \sigma^2_\varepsilon}\\
k_3^{(2)}  &\rightarrow \frac{\sigma^2_{\zeta,1}}{\sigma^2_{\eta,1} + \sigma^2_{\eta,2} + \sigma^2_{\zeta,1} + \sigma^2_\varepsilon}
\end{aligned}
$$

